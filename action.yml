name: "AccessDB Diff"
description: "Generate diffs for accessdb files"

outputs:
  has-accdb-files:
    description: "True if accdb files were found"
    value: ${{ steps.list-accdb-files.outputs.has-accdb-files }}
  accdb-diffs:
    description: "Text of accdb diff"
    value: ${{ steps.generate-accdb-diff.outputs.accdb-diff }}

runs:
  using: "composite"
  steps:
    - id: list-accdb-files
      env:
        GITHUB_ACTION_PATH: ${{ github.action_path }}
      run: |
        added=$(${{ github.action_path }}/list-accdb-files.sh ${{ github.event.pull_request.head.sha }} "A" )
        modified=$(${{ github.action_path }}/list-accdb-files.sh ${{ github.event.pull_request.head.sha }} "M" )
        result="$added $modified"
        if [ -n "$result" ]
        then 
          echo "HAS_ACCDB_FILES=true" >> $GITHUB_ENV
          echo "::set-output name=has-accdb-files::$result" 
        else          
          echo "HAS_ACCDB_FILES=false" >> $GITHUB_ENV
        fi
      shell: bash

    - id: install-mdbtools
      run: |
        if [ ${{ env.HAS_ACCDB_FILES }} = true ]
        then
          sudo apt update
          sudo apt --assume-yes install mdbtools
        fi
      shell: bash

    - id: install-csvtojson
      run: |
        if [ ${{ env.HAS_ACCDB_FILES }} = true ]
         then
           sudo npm i -g csvtojson
         fi
      shell: bash

    - id: generate-accdb-diff
      env:
        GITHUB_ACTION_PATH: ${{ github.action_path }}
      run: |
        if [ ${{ env.HAS_ACCDB_FILES }} = true ]
         then
           IFS=$'\n'
           result=($(${{ github.action_path }}/diff-accdb-files.sh \
             ${{ github.event.pull_request.head.sha }} ${{ github.event.pull_request.base.sha }} \
             | ${{ github.action_path }}/convert-to-markdown-comment.sh \
             | jq --slurp --raw-input '.' \
             | { cat; echo; } )) 
           echo "::set-output name=accdb-diff::${result[@]}"
           echo "${result[@]}"
         fi
      shell: bash
