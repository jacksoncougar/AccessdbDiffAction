name: Diff AccessDB
on: [pull_request]

jobs:
  find-accdb-files:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: List modified accdb files
        id: list-modified-accdb-files
        run: |
          result=$(${{ github.workspace }}/.github/workflows/list-modified-accdb-files.sh ${{ github.event.pull_request.head.sha }} )
          if [ -n "$result" ]; then echo "::set-output name=hasAccdbFiles::true" ; fi;
          echo "::set-output name=accdbFiles::$result"

      - name: Install mdbtools
        id: install-mdbtools
        if: ${{ steps.list-modified-accdb-files.outputs.hasAccdbFiles }}
        run: |
          sudo apt update
          sudo apt --assume-yes install mdbtools

      - name: Install csvtojson
        id: install-csvtojson
        if: ${{ steps.list-modified-accdb-files.outputs.hasAccdbFiles }}
        run: |
          sudo npm i -g csvtojson

      - name: Find accessdb files
        id: accessfiles
        if: ${{ steps.list-modified-accdb-files.outputs.hasAccdbFiles }}
        run: |
          echo "::set-output name=result::$(${{ github.workspace }}/.github/workflows/diff-modified-accdb-files.sh ${{ github.event.pull_request.head.sha }} | jq --slurp --raw-input '.' )"

      - name: Add diff comment to pull request
        id: add-comment
        if: ${{ steps.list-modified-accdb-files.outputs.hasAccdbFiles }}
        env:
          DIFF: ${{ steps.accessfiles.outputs.result }}
        run: |
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -X POST -d '{"body": ${{ env.DIFF }}}' "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.number }}/comments"
